---
title: "FABI Session 3 - Introduction to dplyr"
subtitle: "Forestry and Agricultural Biotechnology Institute, University of Pretoria"
author: "Joey Hulbert"
date: "February 28, 2019"
output: 
  html_document:
    toc: TRUE 
    toc_depth: 5
    toc_float:
      collapsed: FALSE
---
<script>
    $(document).ready(function() {
      $items = $('div#TOC li');
      $items.each(function(idx) {
        num_ul = $(this).parentsUntil('#TOC').length;
        $(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
      });
    });
</script>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r include=FALSE}
library(knitr)
```

[FABI Workshop Series >> Home](http://jmhulbert.github.io/r)
[FABI Workshop Series >> Mock Data](http://jmhulbert.github.io/r/data)


```{r include=FALSE}
library(knitr)
```



## Introduction

Welcome to the third session of our workshop series. The purpose of this page is to serve as a guide for the material we will cover during the session. We will learn to summarize and transform data using the [dplyr](https://dplyr.tidyverse.org/) package in our session today. 


```{r include=FALSE}
library(tidyverse)
```

```{r eval=FALSE}
library(tidyverse)
```


For more information about dyplr, check out the help file

```{r}
?dplyr #note you need to index the tidyverse package for this to work
```

### Download ggplot2 Cheatsheet

Lets start by downloading the cheatsheet for dplyr.

RStudio has produced many 'cheatsheets' for various packages that are super helpful. Each package has many functions and it is impossible to remember them all. 

[dplyr cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf) - click to download.


## Session 2 Recap
### Plots
Remember that we went through examples of plots following the structure of the [ggplot cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/data-visualization-2.1.pdf), first plotting one *continuous* variable, then moving to two variables (one *discrete* and one *continuous*)


```{r}
data <- read.csv('Silver Tree Study.csv')
```

#### One Variable Plots


##### Continuous Data

Remember that we identified a mistake in the data. The plot below has an enormous outlier. 

```{r}
ggplot(data,aes(Photosynthesis))+geom_histogram() #note that this is only a one variable plot (only x, not x and y). 
```

Then remember we filtered out the outlier from our data using **dplyr**

```{r}
data <- data %>% filter(Photosynthesis<300) # we will go over the structure of this after our Session 2 recap. 
```

Here we resaved 'data' as a new data.frame that was filtered. Alternatively we could have saved it as a new variable, but I try not to rename things as much as I can (we will see why later when we have a bunch of dataframes in our environment).

```{r eval=FALSE}
data.filtered <-data %>% filter(Photosynthesis<300) #same as above, just demonstrating that could rename it something else.
```


#### Two Variable Plots

##### Discrete x, Continous y

###### Boxplots

Boxplots are commonly used to show data distributions between groups. 

```{r}
ggplot(data,aes(Species,Photosynthesis,fill=Treatment))+geom_boxplot(position="dodge") +coord_flip()
```

Remember that we are interested in how photosynthesis changed over time (measured by days after inoculation) because the inoculated plant should be the exact same as controls at start of experiment. 


```{r}
data$Days.after.inoculation.factored <- as.factor(data$Days.after.inoculation) #this time I created a new column rather than save over the other column.
```

```{r}
ggplot(data,aes(Days.after.inoculation.factored,Photosynthesis,fill=Species))+geom_boxplot(position="dodge")+facet_wrap(~Treatment,ncol=1)
```


##### Continuous x, Continuous y

Lets look at the data if we keep 'Days.after.inoculation' as an integer rather than a factor. Thus, we are plotting a continuous variable. 

```{r}
ggplot(data,aes(Days.after.inoculation,Photosynthesis,linetype=Treatment,color=Species))+geom_smooth(method=lm)
```


### ggplot2 Extras
#### Labels

There were a few examples that we didn't get to last week that we can go through now quickly. 

First, lets customize the labels of our plots. Suppose we want our x and y labels to be cleaner and more accurate. 

We can add custom labels to our plots using the 'labs' command

```{r}
ggplot(data,aes(Days.after.inoculation,Photosynthesis,linetype=Treatment,color=Species))+geom_smooth(method=lm) +labs(x="Days after inoculation",y=expression(Phyotosnytheic~Response~(Âµmol~m^{-2}~s^{-1}))) #note the crazy notation for adding superscripts
```

#### Titles

We can also add a title using the 'labs' command

```{r}
ggplot(data,aes(Days.after.inoculation,Photosynthesis,linetype=Treatment,color=Species))+geom_smooth(method=lm) +labs(x="Days after inoculation",y="Photosnthesis",title="Photosnythetic Response")
```

Note that ggplot left adjust titles (don't ask me why). To fix this we add a theme command


```{r}
ggplot(data,aes(Days.after.inoculation,Photosynthesis,linetype=Treatment,color=Species))+geom_smooth(method=lm) +labs(x="Days after inoculation",y="Photosynthesis",title="Photosnythetic Response")+theme(plot.title = element_text(hjust = 0.5))
```


#### Italics

Similarly, if we want to add italics to an element, we can add the 'element_text(face="italic") command.

```{r}
ggplot(data,aes(Days.after.inoculation,Photosynthesis,linetype=Treatment,color=Species))+geom_smooth(method=lm) +labs(x="Days after inoculation",y="Photosnthesis",title="Photosnythetic Response") +theme(axis.text.y=element_text(face="italic"), plot.title = element_text(hjust = 0.5,face="italic")) #notice we added italics to the y axis text and the title in this example
```


#### Themes

Themes can also be used to change the basic layout (e.g. background color) of the plot.

Here we can remove the grey background by adding another theme component. 

```{r}
ggplot(data,aes(Days.after.inoculation,Photosynthesis,linetype=Treatment,color=Species))+geom_smooth(method=lm) +labs(x="Days after inoculation",y="Photosynthesis",title="Photosnythetic Response")+theme(plot.title = element_text(hjust = 0.5)) +theme_bw()
```

There are more theme options listed in the [ggplot cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/data-visualization-2.1.pdf). 


#### Colors

The commands for changing the colors vary depending on the type of plot you're creating. For the best results, check out the ggplot2 cheatsheet. In general the command can be summarized as 'scale_aes_colortype()'.

For our plot above we use the color and linetype aesthetics, therefore we can use scale_color_discrete()

```{r}
ggplot(data,aes(Days.after.inoculation,Photosynthesis,linetype=Treatment,color=Species))+geom_smooth(method=lm) +labs(x="Days after inoculation",y="Photosynthesis",title="Photosnythetic Response")+theme(plot.title = element_text(hjust = 0.5)) +theme_bw() +scale_color_brewer(palette="Reds")
```

```{r}
ggplot(data,aes(Species,Photosynthesis,fill=Treatment))+geom_boxplot(position="dodge") +coord_flip() +theme_bw()+scale_fill_grey()
```

#### Add Text

Suppose we want to add text to our plot. For example, perhaps we want to know the mean value or the number of observations in addition to our boxplots above. For this we can use the geom_text command. 

```{r}
ggplot(data,aes(Species,Photosynthesis,color=as.factor(Trial)))+geom_point(position="jitter") +coord_flip()+facet_wrap(~Treatment) +theme_bw()+guides(color=FALSE)+geom_text(aes(label=Plant.Number),position="jitter")
```

Ok that is super messy, but we will come back to this after we summarize some of the data.


#### ggsave

Exporting plots from the plot pane of R studio is certainly the easiest, but the journal you're submitting to may want higher resolution, or you may want to control the size of the text and the spacing. 

Therefore, the ggsave command is helpful.

First save the plot as an object

```{r}
plot <- ggplot(data,aes(Species,Photosynthesis,fill=Treatment))+geom_boxplot(position="dodge") +coord_flip()+scale_fill_grey()
```

Then we can save our themes criteria as objects

```{r}
Space <- theme(axis.title.x=element_text(margin=margin(15,0,0,15)),axis.title.y=element_text(margin=margin(0,15,0,0))) # adds space between x axis text and x axis title

Theme <-  theme(axis.title=element_text(size=12),axis.text = element_text(size=12),strip.text.x=element_text(size=12),axis.text.y = element_text(face="italic"),plot.title = element_text(hjust = 0.5)) +theme_bw()

```

Then we can add them together

```{r}
Plot.for.print <- plot+Space+Theme
```

And then save them

```{r eval=FALSE}
ggsave(filename='./Pretty Plot.png', plot = Plot.for.print, width = 225, height = 110,unit="mm",dpi = 300, limitsize = TRUE)
```



## dplyr

Ok now lets get into the real content of this session. Dplyr is a package that will empower you to quickly and safely (low risk of mistakes) summarize your data.

Lets again look at our data.

```{r}
head(data) #as_tibble is another way to view a table of our data
```

Ok so we can see that the first 10 or so rows are from the same plant (see below) and measured on the same day (day 3). We took at least 10 measurements per plant. Therefore, we need to calculate the mean value per plant (to avoid psuedoreplication). 

The unique sample number is just a combination of 3 columns using the stringr package in the tidyverse (not going into that now).

* The first sample plant is: 
    + Trial = 1
    + Treatment = Drought
    + Species = Control
    + Plant number = 9. 

### Pipes
In general, the dyplr package uses 'pipes' (%>%), which eventually the entire tidyverse will use (including ggvis, the next version of ggplot2). 

You can read the %>% as 'THEN'. 

For example the below code can be interpreted as 

> Data THEN Filter THEN Group_by THEN Summarise

```{r eval=FALSE}
summary <- data %>% filter(Photosynthesis<200) %>% group_by(Species) %>% summarize(mean=mean(Photosynthesis)) #more about this later
```

The pipes essentially let us do everything in one go, without having to create a named variable for every step.. 

We will build up to the command above. 

### Filter Data

We have already used the filter command in the first two sessions, but lets take another look. 

Remember that we included a few plants from species="Both Pathogens" in the first few weeks of the experiment. 

```{r}
levels(data$Species) #we can remind ourselves about the levels of a factor using the levels command
```

Lets remove the "Both Pathogens" from our dataset for now, just to simplify our stats going forward

```{r}
data.filtered <- data %>% filter (Species!="Both Pathogens") #note the '!=' means 'does not equal'
```

Lets check that that worked

```{r}
levels(data.filtered$Species)
```

Oops.. the level is still there

```{r}
summary(data.filtered$Species)
```

Ok, notice that all of the obesrvations for "Both Pathogens" were filtered out, but the level still remains in our factor. (its a silly thing R does). 

> Even though there are no observations, the level of the factor will still appear in our legend if we made a plot now

#### Drop Levels

We can completely drop that level of the factor by including the 'droplevels' command.

```{r}
data.filtered <- data %>% filter (Species!="Both Pathogens") %>% droplevels()
```


```{r}
levels(data.filtered$Species) 
```

Blam.

Note that the indigenous pathogen and exotic pathogen levels actually have spaces behind them.. Whoops. 

### Recode

Suppose we want to change the names of some of our levels in our factors. Sometimes it is easier to do in excel from the start, but if you only want to make one change, it is easier to just use one line of code 

```{r}
data.filtered <- data.filtered %>% mutate(Species = recode(Species, "Indigenous Pathogen "="P. multivora", "Exotic Pathogen "="P. cinnamomi")) 
```

```{r}
levels(data.filtered$Species)
```

Here we used the 'mutate' command. This command is used to create a new column. However, in the above code, we called the column the same name, thereby just replacing the other column. 

### Summary Stats

The dplyr package is most helpful for summarizing data. Below are a few common statistics we will use (mean, sd, se, ci). 

Before we calculate the means we need to introduce the group_by() command.

We can tell R which groups we want to calculate the means for using the group_by() command. For example, if we want to group the plants by treatment we will use:

```{r eval=FALSE}
data.filtered.summary <- data.filtered %>% group_by(treatment) %>%summary(mean=mean(Photosynthesis))
```

#### Number (n) per group

Lets rather start by summarizing the number of measurements made for each plant on each day.

Recall that there are at least 10 measurements per plant, per day of measurement (day after inoc).

```{r}
Plant.Measurements <- data.filtered %>% group_by(Unique.Sample.Number,Days.after.inoculation) %>% summarize(n=n()) #the n=n() is a super nice function in dplyr to calculate the number of rows (measurements in our case).

#We could also do n=length() I think
```

```{r}
as.tibble(Plant.Measurements)
```

Ok, here we can see there are about 10 (10-13) observations (measurements/rows) per plant per measurement day. 

Suppose we want to see how many plants there were per treatment and species.

```{r}
Plant.Count <- data.filtered %>% group_by(Treatment,Species) %>% summarize(n=n_distinct(Unique.Sample.Number))
```

```{r}
ggplot(Plant.Count,aes(Species,n,fill=Treatment))+geom_col(position="dodge") 
```


#### Mean per plant

Ok, next we can look at means.


Lets calculate the mean photosynthesis value per plant (but lets keep all of our other variables of interest by including them in summary)

```{r}
Plant.Mean.Photo <- data.filtered %>% group_by(Unique.Sample.Number,Trial,Treatment,Species,Days.after.inoculation) %>% summarize(plant.average=mean(Photosynthesis,na.rm=TRUE))
```

```{r}
as.tibble(Plant.Mean.Photo)
```

Note that we did not use the same plants every time we took measurements. WE could only measure <30 plants per day, so we randomly selected them from the rows. 

```{r}
ggplot(Plant.Mean.Photo,aes(Species,plant.average,fill=Treatment))+geom_boxplot()
```

Not much different than before, but at least each plant is the sampling unit, rather than each measurement on each plant, which are not independant (and therefore, pseudoreplicates)

#### Mean per group

Ok now that we have the means per plant, we can look at the means per trial, treatment, etc. 

```{r}
Group.Mean.Photo <- Plant.Mean.Photo %>% group_by(Treatment,Species,Days.after.inoculation) %>% summarize(n=n(), mean=mean(plant.average,na.rm=TRUE),sd=sd(plant.average,na.rm=TRUE),se = sd / sqrt(n),lowse = (mean-se),highse = (mean+se)) #notice here we also calculate sd, se, and the low and high values)
```


Below we can plot the mean values of all the plants from each species and each treatment on each day measured. 

```{r}
ggplot(Group.Mean.Photo,aes(as.factor(Days.after.inoculation),mean,color=Species))+geom_point()+facet_wrap(~Treatment,ncol=1) #notice we had to factor days after inoculation
```

We can see there is some missing data. For example, day 3 only has control plants. This is because R does not calculate means of groups that have missing values unless we indicate to do so. 

```{r}
Group.Mean.Photo <- Plant.Mean.Photo %>% group_by(Treatment,Species,Days.after.inoculation) %>% summarize(n=n(), mean=mean(plant.average,na.rm=TRUE),sd=sd(plant.average,na.rm=TRUE),se = sd / sqrt(n),lowse = (mean-se),highse = (mean+se)) #notice here we also calculate sd, se, and the low and high values)
```





```{r}
ggplot(Group.Mean.Photo,aes(Species,mean,color=Treatment))+geom_point()+coord_flip()+facet_wrap(~as.factor(Days.after.inoculation),nrow=2)
```

##### Error bars


```{r}
ggplot(Group.Mean.Photo,aes(as.factor(Days.after.inoculation),mean,color=Species))+geom_point()+facet_wrap(~Treatment,nrow=2) +geom_errorbar(aes(ymin=lowse,ymax=highse))
```

```{r}
Last.Week <- Group.Mean.Photo %>% filter(Days.after.inoculation>22 & Days.after.inoculation!=36)

ggplot(Last.Week,aes(as.factor(Days.after.inoculation),mean,color=Species))+geom_point(position = position_dodge(width = 1))+facet_wrap(~Treatment,nrow=2)+geom_errorbar(aes(ymin=lowse,ymax=highse),position = position_dodge(width = 1)) +labs(x= "Days after inoculation",y="Mean Photosynthesis") +theme_bw()+ theme(legend.text = element_text(face = "italic"))
```

##### Add text
```{r}

ggplot(Last.Week,aes(as.factor(Days.after.inoculation),mean,color=Species))+geom_point(position = position_dodge(width = 1))+facet_wrap(~Treatment,nrow=2)+geom_errorbar(aes(ymin=lowse,ymax=highse),position = position_dodge(width = 1)) +labs(x= "Days after inoculation",y="Mean Photosynthesis") +theme_bw()+ theme(legend.text = element_text(face = "italic"))+geom_text(aes(label=n),position=position_dodge(width=1.1))
```




## Next Session

The next session will cover a small bit of the Vegan Package for multivariate analysis. We will use a different dataset for that 
session because the data has to be set up differently.

You will need to have the presence/absence/abundance data in a single column for each species. 


```{r}
forest.data <- read.csv("Forest_understory_presence.csv")
```

```{r}
as_tibble(forest.data)
```

